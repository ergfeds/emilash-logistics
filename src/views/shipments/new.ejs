<% layout('layouts/admin') %>

<style>
/* Enhanced styles for map and form */
.mapbox-gl-map {
    height: 400px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}
.marker-origin { background-color: #0d6efd; }
.marker-destination { background-color: #198754; }
.marker-current { background-color: #fd7e14; }
.form-section {
    background: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #f0f0f0;
}
.section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
}
.required-badge {
    font-size: 0.75rem;
    color: #6c757d;
    background: #f8f9fa;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.geocoder-container {
    min-height: 40px;
}
.mapboxgl-ctrl-geocoder {
    width: 100%;
    max-width: none;
    box-shadow: none;
    border: 1px solid #ced4da;
}
.route-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}
.route-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.9rem;
}
.route-info i {
    font-size: 1.2rem;
}
</style>

<div class="container-fluid">
<div class="row mb-4">
	<div class="col-12">
            <h1 class="h3 mb-0">ðŸ“¦ Create New Shipment</h1>
            <p class="text-muted mt-1">Complete shipment information with live address validation and route mapping</p>
        </div>
    </div>

    <!-- Live Route Map -->
    <div class="form-section">
        <div class="section-header">
            <h5 class="section-title">
                <i class="bi bi-geo-alt-fill text-primary me-2"></i>Live Route Visualization
            </h5>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshMap()">
                <i class="bi bi-arrow-clockwise"></i> Refresh Map
            </button>
        </div>
        <div id="routeMap" class="mapbox-gl-map mb-3"></div>
        <div id="routeSummary" class="route-summary" style="display:none;">
            <div class="route-info">
                <i class="bi bi-pin-map-fill"></i>
                <span>From: <strong id="routeOrigin">--</strong></span>
                <i class="bi bi-arrow-right mx-2"></i>
                <span>To: <strong id="routeDestination">--</strong></span>
                <span class="ms-auto">
                    <i class="bi bi-rulers me-1"></i>
                    Distance: <strong id="routeDistance">--</strong>
                </span>
            </div>
	</div>
</div>

    <form method="post" action="/admin/shipments" id="shipmentForm">
        
        <!-- Sender Information -->
        <div class="form-section">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="bi bi-person-fill text-info me-2"></i>Sender Information
                </h5>
                <span class="required-badge">* Required fields</span>
		</div>
            
			<div class="row g-3">
				<div class="col-md-4">
					<label class="form-label">Full Name *</label>
                    <input type="text" name="sender_name" class="form-control" required placeholder="John Doe">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Company</label>
                    <input type="text" name="sender_company" class="form-control" placeholder="Acme Corp">
				</div>
				<div class="col-md-4">
					<label class="form-label">Email *</label>
					<input type="email" name="sender_email" class="form-control" required placeholder="john@example.com">
				</div>
				<div class="col-md-4">
                    <label class="form-label">Phone *</label>
                    <input type="tel" name="sender_phone" class="form-control" required placeholder="+1 (555) 123-4567">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Alternative Phone</label>
                    <input type="tel" name="sender_alt_phone" class="form-control" placeholder="+1 (555) 987-6543">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Country *</label>
                    <select name="sender_country" id="senderCountry" class="form-select" required>
                        <option value="US" selected>United States</option>
                        <option value="CA">Canada</option>
                        <option value="MX">Mexico</option>
                        <option value="GB">United Kingdom</option>
                        <option value="FR">France</option>
                        <option value="DE">Germany</option>
                        <option value="AU">Australia</option>
                        <option value="JP">Japan</option>
                        <option value="CN">China</option>
                        <option value="IN">India</option>
                    </select>
				</div>

				<div class="col-12">
                    <label class="form-label">Full Address * <small class="text-muted">(Start typing to search)</small></label>
                    <div id="senderGeocoder" class="geocoder-container"></div>
                    <input type="hidden" id="sender_address" name="sender_address" required>
				<input type="hidden" id="sender_lat" name="sender_lat">
				<input type="hidden" id="sender_lng" name="sender_lng">
                </div>

                <div class="col-md-3">
                    <label class="form-label">City *</label>
                    <input type="text" id="sender_city" name="sender_city" class="form-control" required placeholder="New York">
                </div>
                <div class="col-md-3">
                    <label class="form-label">State/Province *</label>
                    <input type="text" id="sender_state" name="sender_state" class="form-control" required placeholder="NY">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Postal Code *</label>
                    <input type="text" id="sender_postal_code" name="sender_postal_code" class="form-control" required placeholder="10001">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Apt/Suite/Unit</label>
                    <input type="text" name="sender_unit" class="form-control" placeholder="Apt 4B">
			</div>
		</div>
	</div>

        <!-- Receiver Information -->
        <div class="form-section">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="bi bi-person-check-fill text-success me-2"></i>Receiver Information
                </h5>
                <span class="required-badge">* Required fields</span>
		</div>
            
			<div class="row g-3">
				<div class="col-md-4">
					<label class="form-label">Full Name *</label>
                    <input type="text" name="receiver_name" class="form-control" required placeholder="Jane Smith">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Company</label>
                    <input type="text" name="receiver_company" class="form-control" placeholder="Tech Solutions Inc">
				</div>
				<div class="col-md-4">
					<label class="form-label">Email *</label>
					<input type="email" name="receiver_email" class="form-control" required placeholder="jane@example.com">
				</div>
				<div class="col-md-4">
                    <label class="form-label">Phone *</label>
                    <input type="tel" name="receiver_phone" class="form-control" required placeholder="+1 (555) 234-5678">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Alternative Phone</label>
                    <input type="tel" name="receiver_alt_phone" class="form-control" placeholder="+1 (555) 876-5432">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Country *</label>
                    <select name="receiver_country" id="receiverCountry" class="form-select" required>
                        <option value="US" selected>United States</option>
                        <option value="CA">Canada</option>
                        <option value="MX">Mexico</option>
                        <option value="GB">United Kingdom</option>
                        <option value="FR">France</option>
                        <option value="DE">Germany</option>
                        <option value="AU">Australia</option>
                        <option value="JP">Japan</option>
                        <option value="CN">China</option>
                        <option value="IN">India</option>
                    </select>
				</div>

				<div class="col-12">
                    <label class="form-label">Full Address * <small class="text-muted">(Start typing to search)</small></label>
                    <div id="receiverGeocoder" class="geocoder-container"></div>
                    <input type="hidden" id="receiver_address" name="receiver_address" required>
				<input type="hidden" id="receiver_lat" name="receiver_lat">
				<input type="hidden" id="receiver_lng" name="receiver_lng">
                </div>

                <div class="col-md-3">
                    <label class="form-label">City *</label>
                    <input type="text" id="receiver_city" name="receiver_city" class="form-control" required placeholder="Los Angeles">
                </div>
                <div class="col-md-3">
                    <label class="form-label">State/Province *</label>
                    <input type="text" id="receiver_state" name="receiver_state" class="form-control" required placeholder="CA">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Postal Code *</label>
                    <input type="text" id="receiver_postal_code" name="receiver_postal_code" class="form-control" required placeholder="90001">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Apt/Suite/Unit</label>
                    <input type="text" name="receiver_unit" class="form-control" placeholder="Suite 200">
			</div>
		</div>
	</div>

        <!-- Package Details -->
        <div class="form-section">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="bi bi-box-seam-fill text-warning me-2"></i>Package Details
                </h5>
                <span class="required-badge">* Required fields</span>
		</div>
            
			<div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Package Type *</label>
                    <select name="package_type" id="packageType" class="form-select" required>
                        <option value="general" selected>General Cargo</option>
                        <option value="documents">Documents</option>
                        <option value="fragile">Fragile</option>
                        <option value="hazardous">Hazardous Materials</option>
                        <option value="live_animal">Live Animal</option>
                        <option value="perishable">Perishable</option>
                        <option value="electronics">Electronics</option>
                        <option value="clothing">Clothing & Textiles</option>
                        <option value="automotive">Automotive Parts</option>
                        <option value="pharmaceutical">Pharmaceutical</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Service Type *</label>
					<select name="service_type" class="form-select" required>
                        <option value="standard" selected>Standard (5-7 days)</option>
                        <option value="express">Express (2-3 days)</option>
                        <option value="overnight">Overnight (Next day)</option>
						<option value="air_freight">Air Freight</option>
						<option value="sea_freight">Sea Freight</option>
						<option value="land_freight">Land Freight</option>
                        <option value="live_animal">Live Animal Transport</option>
					</select>
				</div>
                <div class="col-md-4">
                    <label class="form-label">Priority Level *</label>
					<select name="priority" class="form-select" required>
                        <option value="low">Low</option>
						<option value="normal" selected>Normal</option>
						<option value="high">High</option>
						<option value="urgent">Urgent</option>
					</select>
				</div>

                <div class="col-md-8">
                    <label class="form-label">Package Description *</label>
                    <textarea name="package_description" class="form-control" rows="2" required placeholder="Describe the contents of the package..."></textarea>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Quantity</label>
                    <input type="number" name="package_quantity" class="form-control" min="1" value="1" placeholder="1">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Weight (lbs) *</label>
                    <input type="number" step="0.01" name="package_weight_lbs" id="weightLbs" class="form-control" required placeholder="10.5">
                    <small class="text-muted">Auto-converts to kg</small>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Length (inches)</label>
                    <input type="number" step="0.01" name="package_length" class="form-control" placeholder="12">
				</div>
				<div class="col-md-3">
                    <label class="form-label">Width (inches)</label>
                    <input type="number" step="0.01" name="package_width" class="form-control" placeholder="8">
				</div>
				<div class="col-md-3">
                    <label class="form-label">Height (inches)</label>
                    <input type="number" step="0.01" name="package_height" class="form-control" placeholder="6">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Declared Value</label>
					<input type="number" step="0.01" name="package_value" class="form-control" placeholder="100.00">
				</div>
                <div class="col-md-3">
                    <label class="form-label">Currency</label>
                    <select name="declared_currency" class="form-select">
                        <option value="USD" selected>USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                        <option value="CAD">CAD</option>
                        <option value="AUD">AUD</option>
                        <option value="JPY">JPY</option>
                        <option value="CNY">CNY</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Insurance Required?</label>
                    <select name="insurance_required" class="form-select">
                        <option value="0" selected>No</option>
                        <option value="1">Yes</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Insurance Value</label>
                    <input type="number" step="0.01" name="insurance_value" class="form-control" placeholder="0.00">
                </div>
            </div>

            <!-- Special Handling Options -->
            <div class="row g-3 mt-3" id="specialHandlingSection" style="display:none;">
                <div class="col-12">
                    <h6 class="text-primary">Special Handling Requirements</h6>
                    <hr>
                </div>
                
                <!-- Live Animal Fields -->
                <div class="live-animal-fields" style="display:none;">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Animal Species</label>
                            <input type="text" name="animal_species" class="form-control" placeholder="e.g., Dog, Cat, Bird">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Health Certificate</label>
                            <select name="animal_health_certificate" class="form-select">
                                <option value="0">No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Special Care Notes</label>
                            <input type="text" name="animal_care_notes" class="form-control" placeholder="Feeding schedule, etc.">
                        </div>
                    </div>
                </div>

                <!-- Temperature Control -->
                <div class="temp-control-fields" style="display:none;">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Temperature Controlled</label>
                            <select name="temperature_controlled" class="form-select">
                                <option value="0">No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Min Temperature (Â°F)</label>
                            <input type="number" name="temperature_min" class="form-control" placeholder="32">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Max Temperature (Â°F)</label>
                            <input type="number" name="temperature_max" class="form-control" placeholder="40">
                        </div>
                    </div>
                </div>

                <!-- Hazardous Materials -->
                <div class="hazmat-fields" style="display:none;">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Dangerous Goods</label>
                            <select name="dangerous_goods" class="form-select">
                                <option value="0">No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">UN Number</label>
                            <input type="text" name="un_number" class="form-control" placeholder="UN1234">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Hazard Class</label>
                            <input type="text" name="hazard_class" class="form-control" placeholder="Class 3">
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Special Handling Required</label>
                    <select name="special_handling_required" class="form-select">
                        <option value="0">No</option>
                        <option value="1">Yes</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">HS Code (for customs)</label>
                    <input type="text" name="hs_code" class="form-control" placeholder="8471.30.0100">
                </div>
            </div>
        </div>

        <!-- Shipping Schedule -->
        <div class="form-section">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="bi bi-calendar-event-fill text-primary me-2"></i>Shipping Schedule
                </h5>
            </div>
            
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Pickup Date</label>
                    <input type="datetime-local" name="pickup_date" class="form-control">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Expected Delivery Date</label>
                    <input type="datetime-local" name="eta" class="form-control">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Incoterms</label>
                    <select name="incoterms" class="form-select">
                        <option value="DAP" selected>DAP - Delivered at Place</option>
                        <option value="DDP">DDP - Delivered Duty Paid</option>
                        <option value="EXW">EXW - Ex Works</option>
                        <option value="FCA">FCA - Free Carrier</option>
                        <option value="CPT">CPT - Carriage Paid To</option>
                        <option value="CIP">CIP - Carriage Insurance Paid</option>
                        <option value="DPU">DPU - Delivered at Place Unloaded</option>
                        <option value="FAS">FAS - Free Alongside Ship</option>
                        <option value="FOB">FOB - Free on Board</option>
                        <option value="CFR">CFR - Cost and Freight</option>
                        <option value="CIF">CIF - Cost Insurance Freight</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Delivery Window Start</label>
                    <input type="datetime-local" name="delivery_window_start" class="form-control">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Delivery Window End</label>
                    <input type="datetime-local" name="delivery_window_end" class="form-control">
                </div>

				<div class="col-12">
                    <label class="form-label">Special Instructions</label>
                    <textarea name="special_instructions" class="form-control" rows="3" placeholder="Any special delivery instructions, handling notes, or requirements..."></textarea>
				</div>
			</div>
		</div>

        <!-- Initial Status -->
        <div class="form-section">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="bi bi-flag-fill text-info me-2"></i>Initial Status
                </h5>
	</div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Current Status</label>
                    <select name="current_status_id" class="form-select">
                        <option value="1" selected>Order Received</option>
                        <% if (typeof statuses !== 'undefined' && statuses) { %>
                            <% statuses.forEach(status => { %>
                                <% if (status.id !== 1) { %>
                                    <option value="<%= status.id %>"><%= status.name %></option>
                                <% } %>
                            <% }) %>
                        <% } %>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Initial Location <small class="text-muted">(Optional)</small></label>
                    <div id="currentLocationGeocoder" class="geocoder-container"></div>
                    <input type="hidden" id="current_location" name="current_location">
                    <input type="hidden" id="current_lat" name="current_lat">
                    <input type="hidden" id="current_lng" name="current_lng">
                </div>
            </div>
        </div>

        <!-- Hidden fields for auto-generated values -->
	<input type="hidden" id="origin" name="origin">
	<input type="hidden" id="destination" name="destination">
        <input type="hidden" id="package_weight" name="package_weight">
        <input type="hidden" id="package_dimensions" name="package_dimensions">

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between align-items-center mt-4">
            <a href="/admin/shipments" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Cancel
            </a>
            <div>
                <button type="button" class="btn btn-outline-primary me-2" onclick="validateForm()">
                    <i class="bi bi-check-circle me-2"></i>Validate
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>Create Shipment
                </button>
            </div>
	</div>
</form>
</div>

<script>
// Global map and marker variables
let routeMap;
let originMarker, destinationMarker, currentMarker;
let routeLine;
let senderGeocoder, receiverGeocoder, currentGeocoder;

document.addEventListener('DOMContentLoaded', function() {
    // Check if Mapbox is available
    if (!window.mapboxgl || !window.MAPBOX_TOKEN) {
        console.warn('Mapbox not available');
        return;
    }
    
	mapboxgl.accessToken = window.MAPBOX_TOKEN;

    // Initialize the route map
    initializeRouteMap();
    
    // Initialize geocoders for address autocomplete
    initializeGeocoders();
    
    // Setup form handlers
    setupFormHandlers();
});

function initializeRouteMap() {
    routeMap = new mapboxgl.Map({
        container: 'routeMap',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [-98.5795, 39.8283], // Center of USA
        zoom: 4
    });
    
    routeMap.addControl(new mapboxgl.NavigationControl(), 'top-right');
    routeMap.addControl(new mapboxgl.FullscreenControl(), 'bottom-right');
    
    // Initialize route line source
    routeMap.on('load', function() {
        routeMap.addSource('route', {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': []
                }
            }
        });
        
        routeMap.addLayer({
            'id': 'route',
            'type': 'line',
            'source': 'route',
            'layout': {
                'line-join': 'round',
                'line-cap': 'round'
            },
            'paint': {
                'line-color': '#0d6efd',
                'line-width': 4,
                'line-opacity': 0.75
            }
        });
    });
}

function initializeGeocoders() {
    // Sender address geocoder
    senderGeocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false,
        placeholder: 'Search for sender address...',
        countries: document.getElementById('senderCountry').value || 'US'
    });
    
    senderGeocoder.addTo('#senderGeocoder');
    
    senderGeocoder.on('result', function(e) {
        const result = e.result;
        updateSenderAddress(result);
        updateMapMarker('origin', result.center, result.place_name);
        updateRoute();
    });
    
    // Receiver address geocoder
    receiverGeocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false,
        placeholder: 'Search for receiver address...',
        countries: document.getElementById('receiverCountry').value || 'US'
    });
    
    receiverGeocoder.addTo('#receiverGeocoder');
    
    receiverGeocoder.on('result', function(e) {
        const result = e.result;
        updateReceiverAddress(result);
        updateMapMarker('destination', result.center, result.place_name);
        updateRoute();
    });
    
    // Current location geocoder (optional)
    currentGeocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
			mapboxgl: mapboxgl,
			marker: false,
        placeholder: 'Search for current location (optional)...'
    });
    
    currentGeocoder.addTo('#currentLocationGeocoder');
    
    currentGeocoder.on('result', function(e) {
        const result = e.result;
        document.getElementById('current_location').value = result.place_name;
        document.getElementById('current_lat').value = result.center[1];
        document.getElementById('current_lng').value = result.center[0];
        updateMapMarker('current', result.center, result.place_name);
    });
}

function updateSenderAddress(result) {
    // Update hidden fields
    document.getElementById('sender_address').value = result.place_name;
    document.getElementById('sender_lat').value = result.center[1];
    document.getElementById('sender_lng').value = result.center[0];
    
    // Parse and fill address components
    const context = result.context || [];
    let city = '', state = '', postalCode = '';
    
    // Extract from context
    context.forEach(item => {
        if (item.id.startsWith('place')) city = item.text;
        if (item.id.startsWith('region')) state = item.short_code ? item.short_code.replace('US-', '') : item.text;
        if (item.id.startsWith('postcode')) postalCode = item.text;
    });
    
    // Update form fields
    document.getElementById('sender_city').value = city || result.text || '';
    document.getElementById('sender_state').value = state;
    document.getElementById('sender_postal_code').value = postalCode;
    
    // Update origin field
    const origin = city && state ? `${city}, ${state}` : result.place_name;
    document.getElementById('origin').value = origin;
    
    // Update route summary
    document.getElementById('routeOrigin').textContent = origin;
}

function updateReceiverAddress(result) {
    // Update hidden fields
    document.getElementById('receiver_address').value = result.place_name;
    document.getElementById('receiver_lat').value = result.center[1];
    document.getElementById('receiver_lng').value = result.center[0];
    
    // Parse and fill address components
    const context = result.context || [];
    let city = '', state = '', postalCode = '';
    
    // Extract from context
    context.forEach(item => {
        if (item.id.startsWith('place')) city = item.text;
        if (item.id.startsWith('region')) state = item.short_code ? item.short_code.replace('US-', '') : item.text;
        if (item.id.startsWith('postcode')) postalCode = item.text;
    });
    
    // Update form fields
    document.getElementById('receiver_city').value = city || result.text || '';
    document.getElementById('receiver_state').value = state;
    document.getElementById('receiver_postal_code').value = postalCode;
    
    // Update destination field
    const destination = city && state ? `${city}, ${state}` : result.place_name;
    document.getElementById('destination').value = destination;
    
    // Update route summary
    document.getElementById('routeDestination').textContent = destination;
}

function updateMapMarker(type, coordinates, title) {
    // Remove existing marker if any
    if (type === 'origin' && originMarker) {
        originMarker.remove();
    } else if (type === 'destination' && destinationMarker) {
        destinationMarker.remove();
    } else if (type === 'current' && currentMarker) {
        currentMarker.remove();
    }
    
    // Create new marker
    const el = document.createElement('div');
    el.className = 'marker';
    el.style.width = '30px';
    el.style.height = '30px';
    el.style.borderRadius = '50%';
    el.style.border = '3px solid white';
    el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
    
    if (type === 'origin') {
        el.style.backgroundColor = '#0d6efd';
        originMarker = new mapboxgl.Marker(el)
            .setLngLat(coordinates)
            .setPopup(new mapboxgl.Popup({ offset: 25 }).setText(`Origin: ${title}`))
            .addTo(routeMap);
    } else if (type === 'destination') {
        el.style.backgroundColor = '#198754';
        destinationMarker = new mapboxgl.Marker(el)
            .setLngLat(coordinates)
            .setPopup(new mapboxgl.Popup({ offset: 25 }).setText(`Destination: ${title}`))
            .addTo(routeMap);
    } else if (type === 'current') {
        el.style.backgroundColor = '#fd7e14';
        currentMarker = new mapboxgl.Marker(el)
            .setLngLat(coordinates)
            .setPopup(new mapboxgl.Popup({ offset: 25 }).setText(`Current: ${title}`))
            .addTo(routeMap);
    }
}

async function updateRoute() {
    const senderLat = document.getElementById('sender_lat').value;
    const senderLng = document.getElementById('sender_lng').value;
    const receiverLat = document.getElementById('receiver_lat').value;
    const receiverLng = document.getElementById('receiver_lng').value;
    
    if (senderLat && senderLng && receiverLat && receiverLng) {
        // Show route summary
        document.getElementById('routeSummary').style.display = 'block';
        
        // Update route line on map
        const coordinates = [
            [parseFloat(senderLng), parseFloat(senderLat)],
            [parseFloat(receiverLng), parseFloat(receiverLat)]
        ];
        
        if (routeMap.getSource('route')) {
            routeMap.getSource('route').setData({
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': coordinates
			}
		});
	}

        // Fit map to show both markers
        const bounds = new mapboxgl.LngLatBounds();
        coordinates.forEach(coord => bounds.extend(coord));
        routeMap.fitBounds(bounds, { padding: 100 });
        
        // Calculate distance (straight line for now)
        const distance = calculateDistance(senderLat, senderLng, receiverLat, receiverLng);
        document.getElementById('routeDistance').textContent = `${distance.toFixed(0)} miles`;
        
        // Optional: Get actual route from Mapbox Directions API
        try {
            const response = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${senderLng},${senderLat};${receiverLng},${receiverLat}?geometries=geojson&access_token=${mapboxgl.accessToken}`);
            const data = await response.json();
            
            if (data.routes && data.routes[0]) {
                const route = data.routes[0];
                
                // Update route line with actual path
                routeMap.getSource('route').setData({
                    'type': 'Feature',
                    'properties': {},
                    'geometry': route.geometry
                });
                
                // Update distance with actual route distance
                const actualDistance = (route.distance * 0.000621371).toFixed(0); // Convert meters to miles
                document.getElementById('routeDistance').textContent = `${actualDistance} miles`;
            }
        } catch (error) {
            console.warn('Could not fetch route details:', error);
        }
    }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    // Haversine formula for distance calculation
    const R = 3959; // Radius of Earth in miles
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function setupFormHandlers() {
    // Convert pounds to kilograms
    document.getElementById('weightLbs').addEventListener('input', function() {
        const lbs = parseFloat(this.value) || 0;
        const kg = lbs * 0.453592;
        document.getElementById('package_weight').value = kg.toFixed(2);
    });
    
    // Calculate dimensions string
    ['package_length', 'package_width', 'package_height'].forEach(id => {
        const elem = document.querySelector(`[name="${id}"]`);
        if (elem) {
            elem.addEventListener('input', updateDimensions);
        }
    });
    
    // Package type change handler
    document.getElementById('packageType').addEventListener('change', function() {
        const specialSection = document.getElementById('specialHandlingSection');
        const liveAnimalFields = document.querySelector('.live-animal-fields');
        const tempControlFields = document.querySelector('.temp-control-fields');
        const hazmatFields = document.querySelector('.hazmat-fields');
        
        // Hide all special fields first
        if (liveAnimalFields) liveAnimalFields.style.display = 'none';
        if (tempControlFields) tempControlFields.style.display = 'none';
        if (hazmatFields) hazmatFields.style.display = 'none';
        
        // Show relevant fields based on package type
        if (this.value === 'live_animal') {
            specialSection.style.display = 'block';
            if (liveAnimalFields) liveAnimalFields.style.display = 'block';
        } else if (this.value === 'perishable' || this.value === 'pharmaceutical') {
            specialSection.style.display = 'block';
            if (tempControlFields) tempControlFields.style.display = 'block';
        } else if (this.value === 'hazardous') {
            specialSection.style.display = 'block';
            if (hazmatFields) hazmatFields.style.display = 'block';
        } else if (this.value === 'fragile') {
            specialSection.style.display = 'block';
        } else {
            specialSection.style.display = 'none';
        }
    });
    
    // Country change handlers to update geocoder
    document.getElementById('senderCountry').addEventListener('change', function() {
        if (senderGeocoder) {
            senderGeocoder.setCountries(this.value);
        }
    });
    
    document.getElementById('receiverCountry').addEventListener('change', function() {
        if (receiverGeocoder) {
            receiverGeocoder.setCountries(this.value);
        }
    });
}

function updateDimensions() {
    const length = document.querySelector('[name="package_length"]').value || 0;
    const width = document.querySelector('[name="package_width"]').value || 0;
    const height = document.querySelector('[name="package_height"]').value || 0;
    
    if (length && width && height) {
        document.getElementById('package_dimensions').value = `${length}x${width}x${height}`;
    }
}

function refreshMap() {
    if (routeMap) {
        routeMap.resize();
        updateRoute();
    }
}

function validateForm() {
    const form = document.getElementById('shipmentForm');
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
    let firstInvalid = null;
    
    requiredFields.forEach(field => {
        if (!field.value || field.value.trim() === '') {
            field.classList.add('is-invalid');
            isValid = false;
            if (!firstInvalid) firstInvalid = field;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        firstInvalid.focus();
        alert('Please fill in all required fields marked with *');
    } else {
        alert('Form validation passed! Ready to submit.');
    }
    
    return isValid;
}
</script>
